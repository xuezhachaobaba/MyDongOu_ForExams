### 一、 索引集
索引集是我们模型中所有“基本元素”的集合。

+ **T (Teachers)**:
    - **定义**: 所有可能参与监考或坐班的教师集合。
    - **例子**: $ t \in T $, $ T = \{\text{张老师}, \text{李老师}, \text{王老师}, ...\} $
+ **S (Slots)**:
    - **定义**: 考试被划分成的所有独立的时间段（一个时段对应一场考试）。
    - **例子**: $ s \in S $, $ S = \{\text{周一上午第1场(9:00-11:00)}, \text{周一下午第1场(14:00-15:30)}, ...\} $
+ **R (Rooms)**:
    - **定义**: 所有可用于“考场”或“自习室”的教室集合。
    - **例子**: $ r \in R $, $ R = \{\text{高二(1)班教室}, \text{高二(2)班教室}, \text{501机房}, ...\} $
+ **K (Subjects)**:
    - **定义**: 本次考试涉及的所有科目集合。
    - **例子**: $ k \in K $, $ K = \{\text{语文}, \text{数学}, \text{物理}, \text{历史}, ...\} $
+ **D (Days)**:
    - **定义**: 考试所涉及的所有日期集合。
    - **例子**: $ d \in D $, $ D = \{\text{2025-11-12}, \text{2025-11-13}, ...\} $

### 二、 参数
参数是模型的“已知条件”，是我们在排考前输入给系统的数据。

#### 基础设置 (B1)
+ $ Duration_s $:
    - **定义**: 时间段 $ s $ 的时长（单位：分钟）。
    - **例子**: $ Duration_{\text{"周一上午第1场"}} = 120 $ (min)

#### 考场与科目 (H-E-06, H-E-07)
+ $ IsExamRoom_{r,s} $:
    - **定义**: 0-1 值。在时段 $ s $，教室 $ r $ 是否被用作“**考场**”？(是=1, 否=0)
    - **例子**: $ IsExamRoom_{\text{"高二(1)班"}, \text{"周一上午1"}} = 1 $
+ $ IsStudyHall_{r,s} $:
    - **定义**: 0-1 值。在时段 $ s $，教室 $ r $ 是否被用作“**自习室**”？(是=1, 否=0)
    - **例子**: $ IsStudyHall_{\text{"高二(4)班"}, \text{"周一上午1"}} = 1 $ (假设该班此时自习)
+ $ SubjectInRoom_{r,s,k} $:
    - **定义**: 0-1 值。在时段 $ s $，考场 $ r $ 里考的科目是否是 $ k $？(是=1, 否=0)
    - **例子**: $ SubjectInRoom_{\text{"高二(1)班"}, \text{"周一上午1"}, \text{"语文"}} = 1 $

#### 教师可用性 (H-E-02, 03, 04, 05)
+ $ Unavailable_{t,s} $:
    - **定义**: 0-1 值。教师 $ t $ 在时段 $ s $ 是否“**绝对不可用**”？(是=1, 否=0)
    - **说明**: 这是由“授课(H-E-02)”、“请假(H-E-03)”、“改卷(H-E-04)”共同决定的综合参数。
    - **例子**: $ Unavailable_{\text{"李老师"}, \text{"周一下午1"}} = 1 $ (因为李老师此时有课)
+ $ TeachSubject_{t,k} $:
    - **定义**: 0-1 值。教师 $ t $ 是否教授科目 $ k $？(是=1, 否=0)
    - **例子**: $ TeachSubject_{\text{"张老师"}, \text{"语文"}} = 1 $ (用于 H-E-05 学科回避)

#### 固定任务 (H-E-09)
+ $ FixedTask_{t,r,s} $:
    - **定义**: 0-1 值。教师 $ t $ 是否有“**固定的**”任务，**必须**在时段 $ s $ 被分配到教室 $ r $？
    - **例子**: $ FixedTask_{\text{"王老师"}, \text{"高二(4)班"}, \text{"周一下午1"}} = 1 $ (王老师固定在周一下午1去高二(4)班坐班)

#### 公平性 (B2, S-E-01, S-E-02)
+ $ HistLoad_t $:
    - **定义**: 教师 $ t $ 的“本学期历史核算负荷”（一个浮点数）。
    - **例子**: $ HistLoad_{\text{"张老师"}} = 350.5 $
+ $ C_{inv} $:
    - **定义**: “**监考**”任务的负荷系数。
    - **例子**: $ C_{inv} = 1.0 $
+ $ C_{sup} $:
    - **定义**: “**自习坐班**”任务的负荷系数。
    - **例子**: $ C_{sup} = 0.5 $
+ $ W_{cur} $ / $ W_{hist} $:
    - **定义**: “本次负荷”和“历史负荷”在计算总负荷时的权重。
    - **例子**: $ W_{cur} = 0.5 $, $ W_{hist} = 0.5 $

#### 软约束辅助参数 (S-E-03 至 S-E-06)
+ $ SlotInDay_{s,d} $: 0-1 值，时段 $ s $ 是否属于日期 $ d $。
+ $ SlotInAM_{s} $ / $ SlotInPM_{s} $: 0-1 值，时段 $ s $ 是否在“上午”/“下午”。
+ $ IsLunchPair_{s_1,s_2} $: 0-1 值， $ s_1 $ 和 $ s_2 $ 是否构成一组“上午末-下午初”的午休时段对。
+ $ IsLongExam_s $: 0-1 值，时段 $ s $ 的考试是否为“长时科目”（如语数外）。
+ $ AvgLongExamCount $: (浮点数) 预先计算的“平均长时科目数” $ = \frac{\text{总的长时监考场次}}{|T|} $。
+ $ DailyLimit $: 整数，每日负荷的“舒适上限” (S-E-06)，例如 2。
+ $ \lambda_{fair}, \lambda_{long}, \lambda_{lunch}, \lambda_{daily}, \lambda_{conc} $:
    - **定义**: 各软约束的**惩罚权重**。
    - **例子**: $ \lambda_{lunch} = 100 $ (表示我们非常不希望违反午休保障)。

### 三、 决策变量
这是模型要求解的“答案”。

+ $ X_{t,r,s} \in \{0, 1\} $:
    - **定义**: 一个**二进制 (0-1)** 变量。
    - **含义**: $ X_{t,r,s} = 1 $ 表示教师 $ t $ **被指派**到教室 $ r $ 执行时段 $ s $ 的任务。$ X_{t,r,s} = 0 $ 表示未指派。
    - **例子**: 如果模型解出 $ X_{\text{"李老师"}, \text{"高二(1)班"}, \text{"周一上午1"}} = 1 $，这表示“李老师”被分配去监考“周一上午第1场”的“高二(1)班”。

### 四、 辅助变量
辅助变量是模型的“中间计算过程”，它们使约束和目标的表达更清晰、更线性。

+ $ IsAssigned_{t,s} \in \{0, 1\} $: 教师 $ t $ 在时段 $ s $ 是否被分配了**任何**任务。
+ $ CurrentInvLoad_t \ge 0 $: 教师 $ t $ 本次的“监考”原始时长。
+ $ CurrentStudyLoad_t \ge 0 $: 教师 $ t $ 本次的“自习坐班”原始时长。
+ $ CurrentWeightedLoad_t \ge 0 $: 教师 $ t $ 的“本次核算负荷” (S-E-02)。
+ $ TotalWeightedLoad_t \ge 0 $: 教师 $ t $ 的“加权总负荷” (S-E-01)。
+ $ MaxTotalLoad / MinTotalLoad \ge 0 $: 所有教师中的最大/最小“加权总负荷”。
+ $ LongExamCount_t \ge 0 $: 教师 $ t $ 本次承担的“长时科目”监考**次数**。
+ $ ExcessLongExam_t \ge 0 $: 教师 $ t $ 超出“平均长时科目数”的**次数** (S-E-03)。
+ $ ViolatesLunch_{t,s_1,s_2} \in \{0, 1\} $: 教师 $ t $ 是否**违反**了 $ s_1, s_2 $ 构成的午休保障 (S-E-04)。
+ $ DailyCount_{t,d} \ge 0 $: 教师 $ t $ 在日期 $ d $ 的总任务**次数**。
+ $ ExcessDaily_{t,d} \ge 0 $: 教师 $ t $ 在日期 $ d $ 超出“舒适上限”的**次数** (S-E-06)。
+ $ IsAssignedAm_{t,d} \in \{0, 1\} $: 教师 $ t $ 在日期 $ d $ 的**上午**是否有任务。
+ $ IsAssignedPm_{t,d} \in \{0, 1\} $: 教师 $ t $ 在日期 $ d $ 的**下午**是否有任务。
+ $ SplitDay_{t,d} \in \{0, 1\} $: 教师 $ t $ 在日期 $ d $ 的任务是否**跨越了上下午** (S-E-05)。



### 五、 约束 
#### A. 硬约束 (Hard Constraints) - 必须 100% 满足
**1. (H-E-01) 考场/自习室覆盖约束：**

+ **描述**: 每一个“考场”或“自习室”在对应时段，**必须且只能**有**一名**教师。
+ **公式**: $ \sum_{t \in T} X_{t,r,s} = 1 $
+ **条件**: $ \forall s \in S $, $ \forall r \in R $ 且 $ (IsExamRoom_{r,s} = 1 \text{ 或 } IsStudyHall_{r,s} = 1) $

**2. (H-E-01) 教师时空冲突约束：**

+ **描述**: 任何教师 $ t $ 在同一时段 $ s $，**最多只能**在一个教室 $ r $ 出现。
+ **公式**: $ \sum_{r \in R} X_{t,r,s} \le 1 $
+ **条件**: $ \forall t \in T $, $ \forall s \in S $

**3. (H-E-02, 03, 04) 教师不可用约束：**

+ **描述**: 如果教师 $ t $ 在时段 $ s $ “不可用”（因为授课、请假、改卷），那么**不能**给他分配任何任务。
+ **公式**: $ \sum_{r \in R} X_{t,r,s} = 0 $
+ **条件**: $ \forall t \in T $, $ \forall s \in S $ 且 $ Unavailable_{t,s} = 1 $

**4. (H-E-05) 学科回避约束：**

+ **描述**: 如果教师 $ t $ 教科目 $ k $，那么他**不能**监考 $ k $ 科目的考场。
+ **公式**: $ X_{t,r,s} = 0 $
+ **条件**: $ \forall t, r, s, k $ 且 $ (TeachSubject_{t,k} = 1 \text{ 且 } SubjectInRoom_{r,s,k} = 1) $

**5. (H-E-09) 固定任务约束：**

+ **描述**: 如果教师 $ t $ 有固定任务，则**必须**将其分配到该任务。
+ **公式**: $ X_{t,r,s} = 1 $
+ **条件**: $ \forall (t,r,s) \text{ 且 } FixedTask_{t,r,s} = 1 $

#### B. 辅助变量定义约束 (将决策 $ X $ 翻译为指标)
**6. 教师时段占用 (IsAssigned):**

$ IsAssigned_{t,s} = \sum_{r \in R} X_{t,r,s} \quad \forall t \in T, \forall s \in S $

**7. 公平性负荷计算 (S-E-01, S-E-02):**

$ CurrentInvLoad_t = \sum_{s \in S} \sum_{r \in R} (X_{t,r,s} \times IsExamRoom_{r,s} \times Duration_s) \quad \forall t \in T $

$ CurrentStudyLoad_t = \sum_{s \in S} \sum_{r \in R} (X_{t,r,s} \times IsStudyHall_{r,s} \times Duration_s) \quad \forall t \in T $

$ CurrentWeightedLoad_t = (C_{inv} \times CurrentInvLoad_t) + (C_{sup} \times CurrentStudyLoad_t) \quad \forall t \in T $

$ TotalWeightedLoad_t = (W_{cur} \times CurrentWeightedLoad_t) + (W_{hist} \times HistLoad_t) \quad \forall t \in T $

**8. 公平性极值 (Max/Min Load):**

$ MaxTotalLoad \ge TotalWeightedLoad_t \quad \forall t \in T $

$ MinTotalLoad \le TotalWeightedLoad_t \quad \forall t \in T $

**9. 长时科目平衡 (S-E-03):**

$ LongExamCount_t = \sum_{s \in S} \sum_{r \in R} (X_{t,r,s} \times IsExamRoom_{r,s} \times IsLongExam_s) \quad \forall t \in T $

$ ExcessLongExam_t \ge LongExamCount_t - AvgLongExamCount \quad \forall t \in T $

**10. 午休保障 (S-E-04):**

$ ViolatesLunch_{t,s_1,s_2} \ge IsAssigned_{t,s_1} + IsAssigned_{t,s_2} - 1 \quad \forall t, \forall (s_1,s_2) \text{ 且 } IsLunchPair_{s_1,s_2}=1 $

**11. 每日负荷 (S-E-06):**

$ DailyCount_{t,d} = \sum_{s \in S} (IsAssigned_{t,s} \times SlotInDay_{s,d}) \quad \forall t \in T, \forall d \in D $

$ ExcessDaily_{t,d} \ge DailyCount_{t,d} - DailyLimit \quad \forall t \in T, \forall d \in D $

**12. 任务集中度 (S-E-05):**

$ IsAssignedAm_{t,d} \ge IsAssigned_{t,s} \quad \forall t, d, \forall s \text{ 且 } (SlotInDay_{s,d}=1 \text{ 且 } SlotInAM_s=1) $

$ IsAssignedPm_{t,d} \ge IsAssigned_{t,s} \quad \forall t, d, \forall s \text{ 且 } (SlotInDay_{s,d}=1 \text{ 且 } SlotInPM_s=1) $

$ SplitDay_{t,d} \ge IsAssignedAm_{t,d} + IsAssignedPm_{t,d} - 1 \quad \forall t \in T, \forall d \in D $



### 六、 目标函数 
这是我们要**最小化**的“总惩罚分”。它由所有软约束的惩罚项加权 $ (\lambda) $ 构成。

$ \text{Minimize} \quad P_{Fairness} + P_{LongExam} + P_{Lunch} + P_{Daily} + P_{Concentration} $

**1. (S-E-01) 核心公平性惩罚:**

+ **目标**: 最小化所有教师“总加权负荷”的极差。
+ **公式**: $ P_{Fairness} = \lambda_{fair} \times (MaxTotalLoad - MinTotalLoad) $

**2. (S-E-03) 长时科目平衡惩罚:**

+ **目标**: 最小化所有教师“超出平均长时科目数”的总和。
+ **公式**: $ P_{LongExam} = \lambda_{long} \times (\sum_{t \in T} ExcessLongExam_t) $

**3. (S-E-04) 午休保障惩罚:**

+ **目标**: 最小化“违反午休保障”的总人次。
+ **公式**: $ P_{Lunch} = \lambda_{lunch} \times (\sum_{t,s_1,s_2} ViolatesLunch_{t,s_1,s_2}) $

**4. (S-E-06) 每日负荷惩罚:**

+ **目标**: 最小化所有教师“超出每日舒适上限”的总场次数。
+ **公式**: $ P_{Daily} = \lambda_{daily} \times (\sum_{t \in T} \sum_{d \in D} ExcessDaily_{t,d}) $

**5. (S-E-05) 任务集中度惩罚:**

+ **目标**: 最小化“任务跨越上下午”的总人天次。
+ **公式**: $ P_{Concentration} = \lambda_{conc} \times (\sum_{t \in T} \sum_{d \in D} SplitDay_{t,d}) $

### 
